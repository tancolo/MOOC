# How to Integrate Braintree Into LMS Project

# Overview
So far, we have integrated Braintree into LMS project, have replaced the original PayPal solution.

For now, it works well on server Viacube.

The following article is a summary of this integration process.

# What's the Braintree
>Resources and tools for developers to integrate Braintree's global payments platform.

In our LMS project, we used the Drop-In UI which is very simply.

About more detail, please read this link: https://developers.braintreepayments.com/start/overview

# How to integrate
- First, we should register a sandbox account for testing.
https://www.braintreepayments.com/sandbox?_ga=1.77038416.496449668.1571907017

- Second, add the dependence of SDK to LMS project.

- Third, add key code to test the function.

## The Architecture of Braintree
This diagram shows how your client, your server, and Braintree interact:
https://prnt.sc/qndcgc

- Step 1
Your front-end requests a client token from your server and initializes the client SDK.

- Step 2
Your server generates and sends a client token back to your client using the server SDK.

- Step 3
The customer submits payment information, the client SDK communicates that information to Braintree and returns a payment method nonce.

- Step 4
Your front-end sends the payment method nonce to your server.

- Step 5
Your server code receives the payment method nonce and then uses the server SDK to create a transaction.

## Gradle
https://developers.braintreepayments.com/start/hello-client/android/v3

In LMS project, we uses Braintree V3, in `build.gradle` of module of `feature-purchase-impl`, 
add the following: 
```groovy
dependencies {
  implementation 'com.braintreepayments.api:drop-in:4.4.1'
}
```
Add the Drop-in UI with a few lines of code to get a full-featured checkout with credit card and PayPal payments.

After sync the changing of gradle, we can see these dependence libs as below:
https://prnt.sc/qnd4re

## Dependence Error
If we use Braintree SDK V3, will face this error as below:
```groovy
Could not determine the dependencies of task ':feature-purchase-impl:compileDebugJavaWithJavac'.
> In project 'app' a resolved Google Play services library dependency depends on another at an exact version (e.g. "[1.3.1
  ,2.3]", but isn't being resolved to that version. Behavior exhibited by the library will be unknown.
  
  Dependency failing: com.nimbusds:nimbus-jose-jwt:7.0.1 -> net.minidev:json-smart@[1.3.1,2.3], but json-smart version was
   2.3.
```
Don't worry, it has been fixed by office document.

https://developers.braintreepayments.com/guides/3d-secure/migration/android/v3

Find the subtitle **Enabling 3DS 2**
https://prnt.sc/qnda3l

# The Workflow Of Purchase
The entire workflow of purchase contains 2 parts.
- **Part 1: Get the plans/Create purchase**
- **Part 2: Checkout**

Regards **Part 1** we didn't change the code. In this document we just only focus on **Part 2** 

## Module of Purchase
All of the code is in module `feature-purchase-impl` 

For *Part 1*, the code covers in these files https://prnt.sc/qneui0.
And the workflow looks like this: https://prnt.sc/qnesfs

For *Part 2: Checkout* contains 2 APIs, first one is getting braintree token, 
the last one is posting payment nonce to SS(server side).

The related code are in these files: https://prnt.sc/qnf15m  

## APIs
In this subtitle I will introduce the APIs of Checkout.
There are 2 APIs:
- **getBraintreeToken,  HTTP GET method** 

The entire url is " https://online.axel.org/opus/braintree.json?_a=get_token&code=ff701b08ccb65b09&app=touch&task_id=a8ff4048-2ac7-4846-837e-912b5dfe40be "

The parameters are as below:
- "code"    : Purchase id obtained after creating purchase on the opus server {@link PurchaseService#createPurchase}
- "app"     : "touch" or "web", for Android client we use "touch"
- "task_id" : UUID id generated by client, unique UUID used only for searching in logs on Server.
 
The response looks like this:
```json
{"data":{"token":"eyJ2ZXJzaW9uIjoy......Zlbm1vIjoib2ZmIn0=","code":"b45d1b0896e5eb04"},"code":"0"}
```  

The `token` is used to launch the Drop-In of Braintree, the `code` is used for parameters of second API.


- **completePurchase, HTTP POST method**

The entire url is " https://online.viacube.com/opus/braintree.json?_a=create_transaction "
```json
code=244d1aca5a171200&payment_method_nonce=tokencc_bh_z4fyss_6vfngv_h2p59y_xw2hnf_7c4&task_id=106021cb-56bc-447e-af69-3f3e3b404b92&app=touch
```

The posting parameters are as below:
- "code"  : the response of method of {@link PurchaseService#getBraintreeToken}.
- "payment_method_nonce" : After user input credit card number or something in UI of Drop-In, the Braintree will return a payment method nonce to Client.
- "task_id" : the same with the parameter "task_id" in API of `getBraintreeToken`.
- "app"     : "touch" or "web", for Android client we use "touch"

The response looks like this:
```json
{"data":"Completed","code":"0"}
```

**Other response:**
If there is DB error in server, it would response data looks like this:
```json
{"data":"Database error","code":"payment.save-14","context":"braintree.get_token"}
```


